
<body class="has-background-light has-text-black" style="min-height: 100vh;">
<div class="section p-none">
  <div class="section p-l-lg p-r-lg p-t-md p-b-md" style="display: flex;">
    <h1><span id="update-day-night-container"></span></h1>
    <h1 style="font-weight: 400; font-size: 1rem; margin-left: auto; order: 2;">
      Events updated&nbsp<span id="update-time-container"></span>
    </h1>
  </div>
  <div class="section m-none p-l-lg p-r-lg p-t-sm" style="width: 100vw;">
    <div class="tile is-ancestor is-horizontal"
         style="overflow-x: scroll"
         id="calendar-tiles-container"></div>
  </div>
</div>
</body>

<%= javascript_include_tag "suncalc.js" %>
<%= javascript_include_tag "moment.min.js" %>
<%= javascript_include_tag "config.js" %>

<script type="text/javascript">

class EventDateTime {
  constructor(eventDateTimeItem) {
    this.dateString = eventDateTimeItem['date'];
    this.dateTimeString = eventDateTimeItem['date_time'];
    this.timeZoneString = eventDateTimeItem['time_zone'];
  }

  date() {
    if (this.dateString !== undefined) return new Date(this.dateString);
    if (this.dateTimeString !== undefined) return new Date(this.dateTimeString);
    return undefined;
  }
}

class Creator {
  constructor(creatorItem) {
    this.displayName = creatorItem['display_name'];
    this.email = creatorItem['email'];
    this.id = creatorItem['id'];
  }
}

class Event {
  constructor(eventItem) {
    this.start = new EventDateTime(eventItem['start']);
    this.end = new EventDateTime(eventItem['end']);
    this.creator = new Creator(eventItem['creator']);
    this.htmlLink = eventItem['html_link'];
    this.status = eventItem['status'];
    this.summary = eventItem['summary'];
  }
}

class Calendar {
  constructor(calendarItem) {
    this.summary = calendarItem['summary'];
    this.backgroundColor = calendarItem['background_color'];
    this.foregroundColor = calendarItem['foreground_color'];
  }
}

class CalendarEvent {
  constructor(calendarEventItem) {
    this.calendar = new Calendar(calendarEventItem['calendar']);
    this.event = new Event(calendarEventItem['event']);
  }
}

String.prototype.truncate = function(n) {
  return this.substr(0, n - 1) + (this.length > n ? '&hellip;' : '');
}

function loadUpcomingEvents() {
  fetch('/calendar/events')
  .then(res => res.json())
  .then(json => {
    const calendarEvents = json.map((calendarEventItem) => (new CalendarEvent(calendarEventItem)));
    calendarEvents.sort((a, b) => (a.event.start.date() - b.event.start.date()));

    const container = document.querySelector('#calendar-tiles-container');
    container.innerHTML = '';

    var day = new Date();
    for (let [index, calendarEvent] of calendarEvents.entries()) {
      const calendarElement = document.createElement('div');
      const startDate = calendarEvent.event.start.date();

      const times = SunCalc.getTimes(new Date(), config.location.latitude, config.location.longitude);
      const isNight = moment(times.sunset).isBefore();
      const tileBackgroundColor = isNight ? 'has-background-black' : 'has-background-white';
      if (day.getDate() !== startDate.getDate()) {
        const separatorElement = document.createElement('div');
        separatorElement.innerHTML = `
          <div class="m-r-sm tile ${tileBackgroundColor}" style="width: 0.25rem; height: 100%;"></div>
        `;
        container.appendChild(separatorElement);
        day = startDate;
      }
      const startMoment = moment(startDate);
      const endMoment = moment(calendarEvent.event.end.date());
      calendarElement.innerHTML = `
        <div class="m-r-sm tile is-vertical ${tileBackgroundColor}"
             style="width: 12rem; height: 14rem;">
          <div style="height: 0.25rem; background-color: ${calendarEvent.calendar.backgroundColor};"></div>
          <div class="p-md">
            <h3 style="font-weight: 400; font-size: 1rem;">${calendarEvent.calendar.summary.truncate(20)}</h3>
            <h1 style="font-weight: 700; font-size: 1.25rem;">${calendarEvent.event.summary.truncate(24)}</h1>
            <h3 style="font-weight: 400; font-size: 1rem;"
                class="live-datetime m-b-lg" data-date="${startDate}">${startMoment.fromNow()}</h3>
            <h3 style="font-weight: 400; font-size: 1rem;">${startMoment.calendar()} until ${endMoment.format('LT')}</h3>
          </div>
        </div>
      `;
      container.appendChild(calendarElement);

      const updateTimeContainer = document.getElementById('update-time-container');
      updateTimeContainer.classList.add('live-datetime');
      updateTimeContainer.setAttribute('data-date', new Date());
      updateTimeContainer.innerHTML = moment(new Date()).fromNow();
    }
  });
}

function updateRelativeDatetimes() {
  const elements = document.getElementsByClassName('live-datetime');
  for (let element of elements) {
    const date = new Date(element.dataset.date);
    element.innerHTML = moment(date).fromNow();
  }
}

class DayNightColor {
  constructor(dayCSSName, nightCSSName) {
    this.dayCSSName = dayCSSName;
    this.nightCSSName = nightCSSName;
  }

  switchElementsToNight() {
    console.log(`Switching color ${this.dayCSSName} to night`);
    for (let element of document.querySelectorAll(`.${this.dayCSSName}`)) {
      console.log(element);
      element.classList.remove(this.dayCSSName);
      element.classList.add(this.nightCSSName);
    }
  }

  switchElementsToDay() {
    console.log(`Switching color ${this.nightCSSName} to day`);
    for (let element of document.querySelectorAll(`.${this.nightCSSName}`)) {
      console.log(element);
      element.classList.remove(this.nightCSSName);
      element.classList.add(this.dayCSSName);
    }
  }
}

const colors = [
  new DayNightColor('has-background-white', 'has-background-black'),
  new DayNightColor('has-background-light', 'has-background-dark'),
  new DayNightColor('has-text-black', 'has-text-white'),
  new DayNightColor('has-text-dark', 'has-text-light'),
];

let currentDayNightState;
function updateDayNightState() {
  const times = SunCalc.getTimes(new Date(), config.location.latitude, config.location.longitude);
  if (moment(times.sunset).isBefore() && currentDayNightState !== 'night') {
    for (let color of colors) {
      color.switchElementsToNight();
    }
    currentDayNightState = 'night';
    const updateDayNightContainer = document.getElementById('update-day-night-container');
    updateDayNightContainer.innerHTML = `☀️⬆️ ${moment(times.sunrise).format('LT')}`;
  }
  if (moment(times.sunrise).isBefore() && currentDayNightState !== 'day') {
    for (let color of colors) {
      color.switchElementsToDay();
    }
    currentDayNightState = 'day';
    const updateDayNightContainer = document.getElementById('update-day-night-container');
    updateDayNightContainer.innerHTML = `☀️⬇️ ${moment(times.sunset).format('LT')}`;
  }
}

loadUpcomingEvents();
updateDayNightState();

setInterval(loadUpcomingEvents, 1000 * 60 * 10);
setInterval(updateRelativeDatetimes, 1000);
setInterval(updateDayNightState, 1000 * 60);
</script>
